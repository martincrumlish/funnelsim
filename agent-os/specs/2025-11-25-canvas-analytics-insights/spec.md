# Specification: Canvas Analytics Insights

## Goal

Add real-time analytics and visual insights directly on the funnel canvas, enabling users to understand funnel performance at a glance without leaving the visual builder context.

## User Stories

- As a funnel builder, I want to see revenue generated by each node so I can identify my most valuable offers
- As a marketer, I want to see traffic flow numbers on edges so I can understand how visitors move through my funnel
- As a funnel optimizer, I want visual health indicators so I can quickly spot underperforming nodes
- As a data-driven user, I want what-if sensitivity analysis so I can prioritize which conversion rates to improve
- As a cost-conscious marketer, I want breakeven metrics visible so I can assess funnel profitability quickly

## Core Requirements

### 1. Per-Node Revenue Badge
- Display revenue generated at each node in a small badge
- Position: Bottom-right corner of node card
- Format: Compact currency (e.g., "$4,700" or "$1.2K")
- Styling: Subtle green background to indicate positive contribution

### 2. Traffic Flow Indicators
- Show visitor counts on edge connections
- Position: Near SOURCE node (not midpoint, to avoid overlap with delete button)
- Format: "100 buyers" for yes paths, "900 pass" for no paths
- Must not overlap with existing edge delete button or node handles

### 3. Node Health Indicators
- Color-coded visual indicator based on conversion rate thresholds
- Thresholds: Green (>= 15%), Yellow (5-15%), Red (< 5%)
- Visual: Border glow or accent on node card
- Provides instant visual feedback on node performance

### 4. What-If Sensitivity Markers
- Show impact of +1% conversion improvement on total revenue
- Display: On node HOVER only (tooltip/popover)
- Format: "+1% conversion = +$X revenue"
- Helps users prioritize optimization efforts

### 5. Breakeven Indicator Panel
- New collapsible panel in TOP-RIGHT of canvas
- Same toggle pattern as existing FunnelMetricsTable (bottom-left)
- Shows: "Breakeven: X visitors @ $Y/visitor"
- Key metrics summary for quick reference

## Visual Design

- No mockups provided
- Follow existing FunnelNode card styling patterns
- Match FunnelMetricsTable collapsible panel pattern for new panel
- Use existing color palette: green (#10b981), yellow/amber, red (#ef4444)
- Maintain minimal visual clutter - analytics should enhance, not overwhelm

## Reusable Components

### Existing Code to Leverage

**Components:**
- `src/components/ui/badge.tsx` - For revenue badge styling
- `src/components/ui/tooltip.tsx` - For what-if hover tooltips (Radix-based)
- `src/components/ui/collapsible.tsx` - For breakeven panel toggle
- `src/components/ui/card.tsx` - For panel styling
- `src/components/FunnelMetricsTable.tsx` - Pattern for collapsible panel (position, toggle button, styling)
- `src/components/FunnelNode.tsx` - Node component to extend
- `src/components/CustomEdge.tsx` - Edge component to extend with traffic indicators

**Services/Libraries:**
- `src/lib/funnelCalculations.ts` - Core calculation engine (has metricsMap, processNode logic)
- `formatCurrency()` utility already exists for currency formatting
- ReactFlow EdgeLabelRenderer for edge label positioning

**Patterns to Follow:**
- FunnelMetricsTable uses Collapsible + Card + absolute positioning
- FunnelNode uses memo() for performance optimization
- CustomEdge uses EdgeLabelRenderer for edge labels
- calculateMetrics() in FunnelCanvas already computes per-node metrics

### New Components Required

**BreakevenPanel** (`src/components/BreakevenPanel.tsx`)
- New collapsible panel for top-right placement
- Cannot reuse FunnelMetricsTable directly as it has different content and position
- Will follow same structural pattern

**Traffic flow indicators** (extend CustomEdge)
- CustomEdge already has EdgeLabelRenderer for labels
- Will add secondary label element positioned closer to source node
- No new component needed, extend existing

## Technical Approach

### Feature 1: Per-Node Revenue Badge
- Extend FunnelNodeData interface to include `revenue?: number`
- Pass calculated per-node revenue from FunnelCanvas to FunnelNode via data prop
- Render Badge component in bottom-right of Card
- Use formatCurrency() for display

### Feature 2: Traffic Flow Indicators
- Extend CustomEdge to accept traffic count in data prop
- Calculate label position offset toward source (e.g., 20% along path instead of 50%)
- Use getBezierPath to compute position
- Pass edge traffic data from FunnelCanvas calculateMetrics()

### Feature 3: Breakeven Indicator Panel
- Create BreakevenPanel component following FunnelMetricsTable pattern
- Position: `absolute top-4 right-4`
- Calculate breakeven: visitors needed where revenue equals cost
- Formula: `breakevenVisitors = totalCost / epcPerVisitor`
- Accept metrics props from FunnelCanvas

### Feature 4: Node Health Indicators
- Add conditional border/shadow classes to FunnelNode Card
- Thresholds: `conversion >= 15` green, `>= 5` yellow, `< 5` red
- Use Tailwind ring utilities: `ring-2 ring-green-500/50`, etc.
- Apply conditionally based on conversion prop

### Feature 5: What-If Sensitivity Markers
- Wrap node content with TooltipProvider + Tooltip
- Calculate sensitivity: re-run revenue calculation with conversion+1%
- Show delta on hover: `+1% = +${deltaRevenue}`
- Compute on demand (hover) to avoid performance impact

### Performance Considerations
- Debounce analytics updates with 200ms delay (useEffect with setTimeout)
- Use memo() on new components
- Calculate sensitivity only on hover, not on every render
- Existing calculateMetrics() already runs efficiently; extend rather than duplicate

## Out of Scope

- Modifying existing FunnelMetricsTable structure or content
- Adding new user preferences or settings panels
- Historical analytics or trend data
- Exporting analytics data
- Mobile-specific layouts for canvas analytics
- A/B test integration
- Real-time data from external sources

## Success Criteria

- Per-node revenue badges visible on all nodes without user action
- Traffic flow numbers displayed on edges without overlapping delete button
- Health indicators clearly distinguish good/warning/poor conversion rates
- Hover tooltip shows sensitivity analysis within 100ms
- Breakeven panel opens/closes smoothly like existing metrics panel
- No performance degradation (canvas remains responsive during edits)
- All new UI elements accessible via keyboard
- Existing funnel builder functionality unaffected (auto-save, export, node editing)
- Visual consistency with existing canvas styling
